(()=>{console.log("Q-SCI Clerk Auth: Page loaded");const e="https://www.q-sci.org/auth-callback";let t="de";async function n(){try{console.log("Q-SCI Clerk Auth: Waiting for Clerk SDK..."),await function(e=3e4){return new Promise((t,n)=>{const o=Date.now(),s=()=>{"undefined"!=typeof Clerk?(console.log("Q-SCI Clerk Auth: Clerk SDK loaded successfully"),t()):Date.now()-o>e?n(new Error("Timeout waiting for Clerk SDK to load")):setTimeout(s,100)};s()})}(),console.log("Q-SCI Clerk Auth: Initializing Clerk...");const t=new Clerk("pk_test_b3B0aW1hbC1qZW5uZXQtMzUuY2xlcmsuYWNjb3VudHMuZGV2JA");if(await t.load({signInFallbackRedirectUrl:e,signUpFallbackRedirectUrl:e,signInForceRedirectUrl:e,signUpForceRedirectUrl:e,redirectUrl:e}),console.log("Q-SCI Clerk Auth: Clerk initialized successfully"),t.user)return console.log("Q-SCI Clerk Auth: User already signed in:",t.user.id),void await s(t);const n=document.getElementById("clerk-container");n.innerHTML="",console.log("Q-SCI Clerk Auth: Mounting sign-in component..."),t.mountSignIn(n,{redirectUrl:e,afterSignInUrl:e,afterSignUpUrl:e,signInForceRedirectUrl:e,signUpForceRedirectUrl:e,signInFallbackRedirectUrl:e,signUpFallbackRedirectUrl:e,appearance:{elements:{rootBox:{width:"100%",margin:"0 auto"},card:{margin:"0 auto"}}}}),console.log("Q-SCI Clerk Auth: Sign-in component mounted"),console.log("Q-SCI Clerk Auth: Setting up session listeners...");let o=null,r=0;const l=300;o=setInterval(async()=>{try{if(r++,await t.load(),r%5==0&&(console.log(`Q-SCI Clerk Auth: Checking session... (attempt ${r}/${l})`),console.log("Q-SCI Clerk Auth: Session exists:",!!t.session),console.log("Q-SCI Clerk Auth: User exists:",!!t.user)),t.session&&t.user)console.log("Q-SCI Clerk Auth: Session detected, user signed in"),clearInterval(o),await s(t);else if(r>=l){console.warn("Q-SCI Clerk Auth: Maximum check attempts reached"),clearInterval(o),i("Authentication timeout. Please try again.");const e=document.getElementById("retry-section");e&&(e.style.display="block")}}catch(e){console.error("Q-SCI Clerk Auth: Error checking session:",e)}},1e3)}catch(e){console.error("Q-SCI Clerk Auth: Initialization error:",e),i(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.errorInit"):"Failed to initialize authentication. Please try again.")}}document.addEventListener("DOMContentLoaded",async function(){if(window.QSCIi18n){await window.QSCIi18n.init(),t=window.QSCIi18n.getLanguage(),document.documentElement.lang=t,window.QSCIi18n.translatePage();const e=document.getElementById("language-selector");e&&(e.value=t,e.addEventListener("change",async function(e){await window.QSCIi18n.setLanguage(e.target.value),t=e.target.value,document.documentElement.lang=t,window.QSCIi18n.translatePage()}))}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n();let o=!1;async function s(e){if(o)console.log("Q-SCI Clerk Auth: Already handling sign-in, skipping...");else{o=!0;try{console.log("Q-SCI Clerk Auth: Processing sign-in..."),r(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.authSuccess"):"Authentication successful! Processing...");const t=e.user,n=e.session;if(!t||!n)throw new Error("No user or session found");const o=await n.getToken(),s=t.primaryEmailAddress?.emailAddress||t.emailAddresses[0]?.emailAddress;let l="free";try{const e=await fetch("https://www.q-sci.org/api/auth/subscription-status",{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});e.ok?(l=(await e.json()).subscription_status||"free",console.log("Q-SCI Clerk Auth: Fetched subscription status from backend:",l)):(console.warn("Q-SCI Clerk Auth: Failed to fetch subscription status from backend, status:",e.status),t.publicMetadata&&t.publicMetadata.plan_id?(l="subscribed",console.log("Q-SCI Clerk Auth: Using publicMetadata fallback - user has plan_id, treating as subscribed")):console.log("Q-SCI Clerk Auth: No plan_id in publicMetadata, defaulting to free"))}catch(e){console.error("Q-SCI Clerk Auth: Error fetching subscription status:",e),t.publicMetadata&&t.publicMetadata.plan_id?(l="subscribed",console.log("Q-SCI Clerk Auth: Network error, using publicMetadata fallback - user has plan_id, treating as subscribed")):console.log("Q-SCI Clerk Auth: Network error and no plan_id in publicMetadata, defaulting to free tier")}console.log("Q-SCI Clerk Auth: User data:",{email:s,subscriptionStatus:l,userId:t.id});const a={token:o,email:s,subscriptionStatus:l,userId:t.id,clerkSessionId:n.id};window.opener&&!window.opener.closed?(window.opener.postMessage({type:"CLERK_AUTH_SUCCESS",data:a},"*"),r(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.successClose"):"Success! Closing window..."),setTimeout(()=>{window.close()},1500)):"undefined"!=typeof chrome&&chrome.storage?(await chrome.storage.local.set({qsci_auth_token:a.token,qsci_user_email:a.email,qsci_subscription_status:a.subscriptionStatus,qsci_user_id:a.userId,qsci_clerk_session_id:a.clerkSessionId}),r(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.successClose"):"Success! Closing window..."),setTimeout(()=>{window.close()},1500)):i(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.errorExtension"):"Please open this page from the extension.")}catch(e){console.error("Q-SCI Clerk Auth: Sign-in handling error:",e),i(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.errorProcess"):"Failed to process authentication. Please try again."),o=!1}}}function i(e){const t=document.getElementById("error-message");t.textContent=e,t.style.display="block",document.getElementById("success-message").style.display="none";const n=document.getElementById("retry-section");n&&(n.style.display="block")}function r(e){const t=document.getElementById("success-message");t.textContent=e,t.style.display="block",document.getElementById("error-message").style.display="none";const n=document.getElementById("retry-section");n&&(n.style.display="none")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("retry-btn");e&&e.addEventListener("click",function(){console.log("Q-SCI Clerk Auth: Retry button clicked");const e=document.getElementById("error-message");e&&(e.style.display="none");const t=document.getElementById("retry-section");t&&(t.style.display="none");const o=document.getElementById("clerk-container");o&&(o.innerHTML='\n          <div class="loading">\n            <div class="spinner"></div>\n            <div data-i18n="clerkAuth.loading">Lade Authentifizierung...</div>\n          </div>\n        ',window.QSCIi18n&&window.QSCIi18n.translatePage()),n()})}),window.addEventListener("message",function(e){console.log("Q-SCI Clerk Auth: Received message:",e.data),e.data&&"EXTENSION_PING"===e.data.type&&e.source.postMessage({type:"CLERK_AUTH_READY"},e.origin)})})();