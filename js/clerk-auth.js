(()=>{console.log("Q-SCI Clerk Auth: Page loaded");let e="de";async function n(){try{console.log("Q-SCI Clerk Auth: Waiting for Clerk SDK..."),await function(e=3e4){return new Promise((n,t)=>{const o=Date.now(),s=()=>{"undefined"!=typeof Clerk?(console.log("Q-SCI Clerk Auth: Clerk SDK loaded successfully"),n()):Date.now()-o>e?t(new Error("Timeout waiting for Clerk SDK to load")):setTimeout(s,100)};s()})}(),console.log("Q-SCI Clerk Auth: Initializing Clerk...");const e=new Clerk("pk_test_b3B0aW1hbC1qZW5uZXQtMzUuY2xlcmsuYWNjb3VudHMuZGV2JA");if(await e.load(),console.log("Q-SCI Clerk Auth: Clerk initialized successfully"),e.user)return console.log("Q-SCI Clerk Auth: User already signed in:",e.user.id),void await o(e);const n=document.getElementById("clerk-container");n.innerHTML="",console.log("Q-SCI Clerk Auth: Mounting sign-in component..."),e.mountSignIn(n,{appearance:{elements:{rootBox:{width:"100%"}}}}),console.log("Q-SCI Clerk Auth: Sign-in component mounted"),console.log("Q-SCI Clerk Auth: Setting up session listeners...");let t=null,i=0;const l=300;t=setInterval(async()=>{try{if(i++,await e.load(),i%5==0&&(console.log(`Q-SCI Clerk Auth: Checking session... (attempt ${i}/${l})`),console.log("Q-SCI Clerk Auth: Session exists:",!!e.session),console.log("Q-SCI Clerk Auth: User exists:",!!e.user)),e.session&&e.user)console.log("Q-SCI Clerk Auth: Session detected, user signed in"),clearInterval(t),await o(e);else if(i>=l){console.warn("Q-SCI Clerk Auth: Maximum check attempts reached"),clearInterval(t),s("Authentication timeout. Please try again.");const e=document.getElementById("retry-section");e&&(e.style.display="block")}}catch(e){console.error("Q-SCI Clerk Auth: Error checking session:",e)}},1e3)}catch(e){console.error("Q-SCI Clerk Auth: Initialization error:",e),s(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.errorInit"):"Failed to initialize authentication. Please try again.")}}document.addEventListener("DOMContentLoaded",async function(){if(window.QSCIi18n){await window.QSCIi18n.init(),e=window.QSCIi18n.getLanguage(),document.documentElement.lang=e,window.QSCIi18n.translatePage();const n=document.getElementById("language-selector");n&&(n.value=e,n.addEventListener("change",async function(n){await window.QSCIi18n.setLanguage(n.target.value),e=n.target.value,document.documentElement.lang=e,window.QSCIi18n.translatePage()}))}}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n();let t=!1;async function o(e){if(t)console.log("Q-SCI Clerk Auth: Already handling sign-in, skipping...");else{t=!0;try{console.log("Q-SCI Clerk Auth: Processing sign-in..."),i(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.authSuccess"):"Authentication successful! Processing...");const n=e.user,t=e.session;if(!n||!t)throw new Error("No user or session found");const o=await t.getToken(),l=n.primaryEmailAddress?.emailAddress||n.emailAddresses[0]?.emailAddress,r=n.publicMetadata?.subscription_status||"free";console.log("Q-SCI Clerk Auth: User data:",{email:l,subscriptionStatus:r,userId:n.id});const a={token:o,email:l,subscriptionStatus:r,userId:n.id,clerkSessionId:t.id};window.opener&&!window.opener.closed?(window.opener.postMessage({type:"CLERK_AUTH_SUCCESS",data:a},"*"),i(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.successClose"):"Success! You can close this window."),setTimeout(()=>{window.close()},2e3)):"undefined"!=typeof chrome&&chrome.storage?(await chrome.storage.local.set({qsci_auth_token:a.token,qsci_user_email:a.email,qsci_subscription_status:a.subscriptionStatus,qsci_user_id:a.userId,qsci_clerk_session_id:a.clerkSessionId}),i(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.successClose"):"Success! You can close this window.")):s(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.errorExtension"):"Please open this page from the extension.")}catch(e){console.error("Q-SCI Clerk Auth: Sign-in handling error:",e),s(window.QSCIi18n?window.QSCIi18n.t("clerkAuth.errorProcess"):"Failed to process authentication. Please try again."),t=!1}}}function s(e){const n=document.getElementById("error-message");n.textContent=e,n.style.display="block",document.getElementById("success-message").style.display="none";const t=document.getElementById("retry-section");t&&(t.style.display="block")}function i(e){const n=document.getElementById("success-message");n.textContent=e,n.style.display="block",document.getElementById("error-message").style.display="none";const t=document.getElementById("retry-section");t&&(t.style.display="none")}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("retry-btn");e&&e.addEventListener("click",function(){console.log("Q-SCI Clerk Auth: Retry button clicked");const e=document.getElementById("error-message");e&&(e.style.display="none");const t=document.getElementById("retry-section");t&&(t.style.display="none");const o=document.getElementById("clerk-container");o&&(o.innerHTML='\n          <div class="loading">\n            <div class="spinner"></div>\n            <div data-i18n="clerkAuth.loading">Lade Authentifizierung...</div>\n          </div>\n        ',window.QSCIi18n&&window.QSCIi18n.translatePage()),n()})}),window.addEventListener("message",function(e){console.log("Q-SCI Clerk Auth: Received message:",e.data),e.data&&"EXTENSION_PING"===e.data.type&&e.source.postMessage({type:"CLERK_AUTH_READY"},e.origin)})})();